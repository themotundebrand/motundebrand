<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TMB Admin | Order Management</title>
    <link rel="icon" type="image/png" href="https://i.imgur.com/CVKXV7R.png">
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        brandPinkDark: '#D48A96',
                        brandBlack: '#000000',
                        brandMist: '#93C5FD',
                        brandKidsBlue: '#60A5FA',
                    }
                }
            }
        }
    </script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;700&display=swap');
        body { font-family: 'Inter', sans-serif; background-color: #FBFBFB; overflow-x: hidden; }
        
        /* Sidebar Transitions */
        .sidebar { transition: transform 0.3s ease-in-out; }
        .mobile-overlay { background: rgba(0,0,0,0.4); opacity: 0; pointer-events: none; transition: all 0.3s; }
        .sidebar-active .sidebar { transform: translateX(0); }
        .sidebar-active .mobile-overlay { opacity: 1; pointer-events: auto; }

        .order-card { transition: all 0.2s ease; border-left: 4px solid transparent; }
        .order-card.status-pending { border-left-color: #D48A96; }
        .order-card.status-completed { border-left-color: #10B981; }
        .order-card.status-cancelled { border-left-color: #EF4444; }

        .nav-link { color: #6B7280; transition: all 0.2s; border-left: 4px solid transparent; }
        .nav-link:hover { color: #000; background: #F9FAFB; }
        .nav-link.active { color: #000; background: #F3F4F6; border-left-color: #D48A96; font-weight: 700; }
    </style>
</head>
<body class="text-brandBlack">

    <div class="lg:hidden bg-white border-b p-4 flex justify-between items-center sticky top-0 z-50">
        <span class="font-bold tracking-widest text-xs uppercase">TMB Admin</span>
        <button onclick="toggleSidebar()" class="text-brandBlack text-xl">
            <i class="fa-solid fa-bars-staggered"></i>
        </button>
    </div>

    <div class="flex">
        <div id="overlay" onclick="toggleSidebar()" class="mobile-overlay fixed inset-0 z-40 lg:hidden"></div>
        
        <aside id="sidebar" class="sidebar fixed lg:static inset-y-0 left-0 z-50 w-64 bg-white border-r transform -translate-x-full lg:translate-x-0 h-screen flex flex-col flex-shrink-0">
            <div class="p-8 border-b text-center">
                <h1 class="font-bold tracking-[0.3em] text-sm italic">TMB SYSTEM</h1>
            </div>


            <nav class="flex-1 px-4 py-8 space-y-1 overflow-y-auto">
                  <p class="text-[9px] uppercase tracking-[0.2em] text-gray-400 px-4 mb-4 font-bold">Main</p>
                <a href="tmbdashboard.html" class="nav-link flex items-center px-4 py-3 text-[10px] tracking-widest uppercase font-semibold transition-all">
                    <i class="fa-solid fa-gauge-high mr-3 w-5 text-gray-400"></i> Dashboard
                </a>

                <p class="text-[9px] uppercase tracking-[0.2em] text-gray-400 px-4 mb-4 font-bold">Inventory</p>
                <a href="womenscents.html" class="nav-link flex items-center px-4 py-3 text-[10px] tracking-widest uppercase font-semibold">
                    <i class="fa-solid fa-venus mr-3 w-5 text-brandPinkDark"></i> Women Scents
                </a>
                <a href="menscents.html" class="nav-link flex items-center px-4 py-3 text-[10px] tracking-widest uppercase font-semibold">
                    <i class="fa-solid fa-mars mr-3 w-5 text-gray-400"></i> Men Scents
                </a>
                <a href="bodymistspray.html" class="nav-link flex items-center px-4 py-3 text-[10px] tracking-widest uppercase font-semibold">
                    <i class="fa-solid fa-spray-can mr-3 w-5 text-brandMist"></i> Mists & Sprays
                </a>
                <a href="kidscents.html" class="nav-link flex items-center px-4 py-3 text-[10px] tracking-widest uppercase font-semibold">
                    <i class="fa-solid fa-child mr-3 w-5 text-brandKidsBlue"></i> Kids Scents
                </a>
                
                <div class="pt-8">
                    <p class="text-[9px] uppercase tracking-[0.2em] text-gray-400 px-4 mb-4 font-bold">Business</p>
                    <a href="customer-list.html" class="nav-link flex items-center px-4 py-3 text-[10px] tracking-widest uppercase font-semibold">
                        <i class="fa-solid fa-users mr-3 w-5 text-gray-400"></i> Membership
                    </a>
                    <a href="#" class="nav-link active flex items-center px-4 py-3 text-[10px] tracking-widest uppercase font-semibold">
                        <i class="fa-solid fa-bag-shopping mr-3 w-5 text-brandPinkDark"></i> Orders
                    </a>
                    <a href="analytics.html" class="nav-link flex items-center px-4 py-3 text-[10px] tracking-widest uppercase font-semibold">
                        <i class="fa-solid fa-chart-simple mr-3 w-5 text-gray-400"></i> Analytics
                    </a>
                </div>
            </nav>

            <div class="p-4 border-t">
                <button onclick="logout()" class="w-full flex items-center justify-center px-4 py-3 text-[10px] uppercase tracking-widest font-bold bg-brandBlack text-white hover:bg-red-900 transition-all">
                    <i class="fa-solid fa-power-off mr-2"></i> System Exit
                </button>
            </div>
        </aside>

        <main class="flex-1 p-6 lg:p-12 h-screen overflow-y-auto">
            <header class="flex justify-between items-center mb-10">
                <div>
                    <h2 class="text-2xl font-light tracking-tight">Order Terminal</h2>
                    <p class="text-[9px] uppercase tracking-[0.3em] text-brandPinkDark font-bold">Process & Verify Shipments</p>
                </div>
                <div class="flex gap-4">
                    <select id="statusFilter" onchange="renderOrders()" class="text-[10px] uppercase tracking-widest border p-2 bg-white outline-none">
                        <option value="all">All Status</option>
                        <option value="pending">Pending</option>
                        <option value="completed">Completed</option>
                        <option value="cancelled">Cancelled</option>
                    </select>
                </div>
            </header>

            <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-8">
                <div class="bg-white border p-4 text-center">
                    <p class="text-[8px] uppercase text-gray-400 font-bold">Total Orders</p>
                    <p id="stat-total" class="text-xl font-light">-</p>
                </div>
                <div class="bg-white border p-4 text-center">
                    <p class="text-[8px] uppercase text-gray-400 font-bold text-brandPinkDark">Pending</p>
                    <p id="stat-pending" class="text-xl font-light text-brandPinkDark">-</p>
                </div>
            </div>

            <div id="orders-list" class="space-y-6">
                <div class="text-center py-20">
                    <i class="fa-solid fa-circle-notch animate-spin text-brandPinkDark text-2xl"></i>
                    <p class="text-[10px] uppercase tracking-widest mt-4">Syncing with Central Server...</p>
                </div>
            </div>
        </main>
    </div>

    <script>
        const API_URL = '/api';
        let ALL_ORDERS = [];

        function toggleSidebar() {
            document.body.classList.toggle('sidebar-active');
        }

        function logout() {
            if(confirm("Exit System?")) {
                localStorage.removeItem('tmb_admin_token');
                window.location.href = 'tmbadmin-login.html';
            }
        }

        async function fetchOrders() {
            const token = localStorage.getItem('tmb_admin_token');
            if (!token) { window.location.href = 'tmbadmin-login.html'; return; }

            try {
                const response = await fetch(`${API_URL}/admin/orders`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                
                if (!response.ok) throw new Error("Failed to fetch");
                
                ALL_ORDERS = await response.json();
                updateStats();
                renderOrders();
            } catch (err) {
                console.error(err);
                document.getElementById('orders-list').innerHTML = `<p class="text-center text-red-500 text-xs">Error loading orders.</p>`;
            }
        }

        function updateStats() {
            document.getElementById('stat-total').innerText = ALL_ORDERS.length;
            document.getElementById('stat-pending').innerText = ALL_ORDERS.filter(o => o.status === 'pending').length;
        }

function renderOrders() {
    const container = document.getElementById('orders-list');
    const filter = document.getElementById('statusFilter').value;
    const filtered = ALL_ORDERS.filter(o => filter === 'all' || o.status === filter);

    if (filtered.length === 0) {
        container.innerHTML = `<div class="bg-white border p-10 text-center text-[10px] uppercase tracking-widest text-gray-400">No orders found.</div>`;
        return;
    }

    container.innerHTML = filtered.map(order => {
        // --- CORRECTED DATA MAPPING ---
        // Your backend stores data in 'customerDetails'
        const customer = order.customerDetails || {};
        
        // Handle names: Priority to customerDetails.name, fallback to "Valued Customer"
        const displayName = customer.name || "Customer";
        
        // Contact details
        const email = customer.email || "No email";
        const phone = customer.phone || customer.whatsapp || "No phone";
        
        // Address Handling: If it's a registered member, address is an object.
        // If it's a guest, address might be a string.
        let fullAddress = "No address provided";
        if (typeof customer.address === 'object' && customer.address !== null) {
            const addr = customer.address;
            fullAddress = `${addr.street || ''}, ${addr.city || ''}, ${addr.state || ''}`.replace(/^,|,$/g, '').trim();
        } else if (customer.address) {
            fullAddress = customer.address;
        }
        
        const city = customer.city || (typeof customer.address === 'object' ? customer.address.city : "N/A");
        // ------------------------------

        return `
            <div class="order-card bg-white border shadow-sm p-6 status-${order.status}">
                <div class="flex flex-col md:flex-row justify-between gap-6">
                    <div class="flex-1">
                        <div class="flex items-center gap-3 mb-2">
                            <span class="text-[9px] px-2 py-0.5 border font-bold uppercase tracking-widest ${order.userId && order.userId !== "GUEST" ? 'bg-blue-50 text-blue-600' : 'bg-gray-100 text-gray-600'}">
                                ${order.userId && order.userId !== "GUEST" ? 'Member' : 'Guest'}
                            </span>
                            <span class="text-[10px] text-gray-400 font-mono">#${order._id.slice(-8).toUpperCase()}</span>
                        </div>
                        <h3 class="font-bold text-sm uppercase tracking-wider">${displayName}</h3>
                        <p class="text-[10px] text-gray-500 mt-2"><i class="fa-solid fa-envelope mr-2 w-3"></i> ${email}</p>
                        <p class="text-[10px] text-gray-500 mt-1"><i class="fa-solid fa-phone mr-2 w-3"></i> ${phone}</p>
                        <p class="text-[10px] text-gray-500 mt-1"><i class="fa-solid fa-location-dot mr-2 w-3"></i> ${fullAddress}</p>
                    </div>

                    <div class="flex-[1.5] border-t md:border-t-0 md:border-l md:pl-6 pt-4 md:pt-0">
                        <p class="text-[9px] uppercase tracking-widest text-gray-400 font-bold mb-3">Order Items</p>
                        <div class="space-y-2">
                            ${order.items.map(item => `
                                <div class="flex justify-between items-center text-[11px]">
                                    <span><strong class="uppercase">${item.name}</strong> (x${item.quantity})</span>
                                    <span class="text-gray-400">${item.size || 'Standard'}</span>
                                </div>
                            `).join('')}
                        </div>
                        <div class="mt-4 pt-3 border-t flex justify-between items-center">
                            <span class="text-lg font-light text-brandPinkDark">â‚¦ ${parseFloat(order.totalPrice).toLocaleString()}</span>
                        </div>
                    </div>

                  <div class="flex flex-col justify-center gap-2 border-t md:border-t-0 md:border-l md:pl-6 pt-4 md:pt-0 min-w-[150px]">
    ${order.status === 'pending' ? `
        <button onclick="updateStatus('${order._id}', 'completed')" class="bg-brandBlack text-white text-[9px] uppercase tracking-[0.2em] py-3 px-4 font-bold hover:bg-green-700 transition">Confirm & Ship</button>
        <button onclick="updateStatus('${order._id}', 'cancelled')" class="border border-gray-200 text-gray-400 text-[9px] uppercase tracking-[0.2em] py-3 px-4 font-bold hover:bg-red-50 hover:text-red-500 transition">Cancel</button>
    ` : `
        <div class="text-center">
            <p class="text-[9px] uppercase tracking-widest font-bold ${order.status === 'completed' ? 'text-green-500' : 'text-red-500'}">
                <i class="fa-solid ${order.status === 'completed' ? 'fa-check-double' : 'fa-xmark'} mr-1"></i>
                ${order.status}
            </p>
            ${order.status === 'completed' ? `
                <span class="text-[7px] uppercase bg-green-50 text-green-600 px-1 py-0.5 rounded mt-1 inline-block font-bold">Stock Deducted</span>
            ` : ''}
            <p class="text-[8px] text-gray-400 mt-2">${new Date(order.createdAt).toLocaleDateString()}</p>
        </div>
    `}
</div>
                </div>
            </div>
        `}).join('');
}

      async function updateStatus(orderId, newStatus) {
    // 1. Set context-specific warning
    const actionText = newStatus === 'completed' 
        ? "Confirming will verify payment and PERMANENTLY deduct items from stock. Proceed?" 
        : `Mark order as ${newStatus}?`;

    if (!confirm(actionText)) return;

    const token = localStorage.getItem('tmb_admin_token');
    
    try {
        const response = await fetch(`${API_URL}/admin/orders/${orderId}/status`, {
            method: 'PATCH',
            headers: { 
                'Authorization': `Bearer ${token}`, 
                'Content-Type': 'application/json' 
            },
            body: JSON.stringify({ status: newStatus })
        });
        
        if (response.ok) {
            // Refresh the list to show "Stock Deducted" badge
            fetchOrders();
        } else {
            // Capture specific backend errors (e.g., "Product not found" or "Database error")
            const errorData = await response.json();
            alert(`Update failed: ${errorData.error || 'Unknown error'}`);
        }
    } catch (err) { 
        console.error("Status Update Error:", err);
        alert("Network error. Please check your connection to the TMB System."); 
    }
}

        window.onload = fetchOrders;
    </script>
</body>
</html>